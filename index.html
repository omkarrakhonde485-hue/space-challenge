<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA Space Apps: Embiggen Your Eyes Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent body scroll when modal is open */
        }
        #image-container.grabbing {
            cursor: grabbing;
        }
        #viewer-image {
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .control-btn {
            background-color: rgba(31, 41, 55, 0.7);
            border-radius: 9999px;
            padding: 0.75rem;
            transition: background-color 0.2s;
        }
        .control-btn:hover {
            background-color: rgba(55, 65, 81, 0.9);
        }
        /* Custom slider styling for better visibility and control */
        #zoom-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #4b5563; /* Gray-600 */
            border-radius: 4px;
        }

        #zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6; /* Blue-500 */
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        #zoom-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen">

    <button id="open-modal-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg transition-colors text-lg shadow-lg">
        Launch Embiggen Viewer (Hubble Data)
    </button>

    <!-- Image Viewer Modal -->
    <div id="image-viewer-modal" class="hidden fixed inset-0 z-50 bg-gray-900 flex transition-opacity duration-300">

        <!-- Sidebar for Metadata and AI -->
        <div class="w-1/4 max-w-xs bg-gray-800 p-4 flex flex-col justify-start overflow-y-auto">
            
            <!-- Load New Image Section -->
            <div class="mb-6 pb-4 border-b border-gray-700">
                <h2 class="text-xl font-bold mb-3 text-blue-400">Load New Data</h2>
                <input type="url" id="image-url-input" placeholder="Paste NASA Image URL here" class="w-full p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-yellow-500 focus:border-yellow-500 mb-2 text-sm">
                <button id="load-image-btn" class="w-full flex items-center justify-center py-2 px-4 rounded-lg font-semibold transition-colors text-sm bg-yellow-600 hover:bg-yellow-700 text-white">
                    Load New Image
                </button>
            </div>
            
            <!-- Metadata Panel -->
            <h2 class="text-xl font-bold mb-4 text-blue-400 border-b border-gray-700 pb-2">Data Metadata</h2>
            <dl class="space-y-2 text-sm">
                <div>
                    <dt class="font-medium text-gray-400">Mission:</dt>
                    <dd class="pl-2">Hubble Space Telescope</dd>
                </div>
                <div>
                    <dt class="font-medium text-gray-400">Instrument:</dt>
                    <dd class="pl-2">Advanced Camera for Surveys (ACS)</dd>
                </div>
                <div>
                    <dt class="font-medium text-gray-400">Resolution:</dt>
                    <dd class="pl-2">~50 Megapixels (Simulated)</dd>
                </div>
                <div>
                    <dt class="font-medium text-gray-400">Acquisition Date:</dt>
                    <dd class="pl-2">2023-09-15 (Inferred)</dd>
                </div>
            </dl>

            <!-- AI Discovery Panel -->
            <h2 class="text-xl font-bold mt-8 mb-4 text-purple-400 border-b border-gray-700 pb-2">AI Summary & Discovery</h2>
            <textarea id="ai-prompt" class="w-full p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-purple-500 focus:border-purple-500 mb-3 text-sm resize-none h-40" placeholder="Optional: Ask for specific analysis (e.g., 'Identify anomalies'). Leave blank for a general summary."></textarea>
            <button id="ai-analyze-btn" class="w-full flex items-center justify-center py-2 px-4 rounded-lg font-semibold transition-colors text-sm bg-purple-600 hover:bg-purple-700 text-white">
                Generate Summary / Analyze
            </button>
            
            <div id="ai-response-area" class="mt-4 p-3 bg-gray-700 rounded-lg text-xs min-h-[40px] overflow-y-auto flex-grow">
                <p class="text-gray-400 italic">AI analysis results will appear here.</p>
            </div>
        </div>

        <!-- Image Container (Main Viewport) -->
        <div id="image-container" class="relative flex-grow h-full overflow-hidden transition-all duration-300">
            <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center z-20 bg-gray-900 bg-opacity-70">
                 <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <!-- The actual image element -->
            <img id="viewer-image" src="https://science.nasa.gov/wp-content/uploads/2023/09/stsci-01ga76rm0c11w977jrhgj5j26x-2.png" alt="Hubble Image of Globular Cluster M15" class="absolute invisible" style="transform-origin: center center;" crossorigin="anonymous">
            
            <!-- Close Button -->
            <button id="close-modal" class="absolute top-4 right-4 text-white text-5xl font-light hover:text-gray-300 transition-colors z-30">&times;</button>
        
            <!-- Controls Bar -->
            <div class="absolute bottom-5 left-1/2 -translate-x-1/2 flex items-center flex-wrap justify-center gap-2 p-2 z-30">
                
                <!-- Zoom Slider -->
                <input type="range" id="zoom-slider" min="0" max="100" value="0" step="1" class="w-32 h-2 cursor-pointer" title="Zoom Level">
                
                <span id="zoom-level" class="text-white font-semibold w-16 text-center bg-gray-800 bg-opacity-70 rounded-full py-3">100%</span>
                
                <button id="reset-view" class="control-btn" title="Reset View">
                    <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.691V5.006h-4.992a8.25 8.25 0 00-11.665 0L2.985 7.694m16.023 1.654L19.005 7.694a8.25 8.25 0 00-11.664 0L2.985 9.348" /></svg>
                </button>
                 <button id="rotate-left" class="control-btn" title="Rotate Left">
                    <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 15l-6 6m0 0l-6-6m6 6V9a6 6 0 0112 0v3" /></svg>
                </button>
                 <button id="rotate-right" class="control-btn" title="Rotate Right">
                    <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15l6 6m0 0l6-6m-6 6V9a6 6 0 00-12 0v3" /></svg>
                </button>
                <button id="flip-horizontal" class="control-btn" title="Flip Horizontal">
                    <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.88 7.823a7.5 7.5 0 00-11.215 0m11.215 0v.003V12m0-4.177v-.003c-.354.211-.72.398-1.096.562a19.498 19.498 0 01-8.02 0c-.376-.164-.742-.35-1.096-.562v.003zM4.5 12V9.284a1.5 1.5 0 01.98-1.423l5.093-2.546a1.5 1.5 0 011.854 0l5.093 2.546a1.5 1.5 0 01.98 1.423V12M4.5 12v6.529c0 .828.672 1.5 1.5 1.5h12a1.5 1.5 0 001.5-1.5V12" /></svg>
                </button>
                 <button id="fullscreen-btn" class="control-btn" title="Toggle Fullscreen">
                     <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // DOM Elements
        const openModalBtn = document.getElementById('open-modal-btn');
        const modal = document.getElementById('image-viewer-modal');
        const closeModal = document.getElementById('close-modal');
        const viewerImage = document.getElementById('viewer-image');
        const imageContainer = document.getElementById('image-container');
        const loadingSpinner = document.getElementById('loading-spinner');

        // New DOM Elements for Image Loading & AI
        const imageUrlInput = document.getElementById('image-url-input');
        const loadImageBtn = document.getElementById('load-image-btn');
        const aiPromptInput = document.getElementById('ai-prompt');
        const aiAnalyzeBtn = document.getElementById('ai-analyze-btn');
        const aiResponseArea = document.getElementById('ai-response-area');
        
        // New DOM Element for Zoom Slider
        const zoomSlider = document.getElementById('zoom-slider');

        // Control Buttons
        const resetViewBtn = document.getElementById('reset-view');
        const zoomLevelDisplay = document.getElementById('zoom-level');
        const rotateLeftBtn = document.getElementById('rotate-left');
        const rotateRightBtn = document.getElementById('rotate-right');
        const flipHorizontalBtn = document.getElementById('flip-horizontal');
        const fullscreenBtn = document.getElementById('fullscreen-btn');

        // State variables
        let state = {
            scale: 1,
            translateX: 0,
            translateY: 0,
            rotate: 0,
            flipX: 1
        };
        
        const minScale = 0.2; // Minimum zoom level (20%)
        const maxScale = 8;   // Maximum zoom level (800%)

        let panning = false;
        let start = { x: 0, y: 0 };
        let lastTouchDistance = null;

        // Image object used for loading/preloading
        let currentImage = new Image();

        // --- Utility Functions for Slider/Scale Mapping ---
        function scaleToSlider(scale) {
            // Maps scale (0.2 to 8) to slider range (0 to 100)
            return ((scale - minScale) / (maxScale - minScale)) * 100;
        }

        function sliderToScale(sliderValue) {
            // Maps slider range (0 to 100) back to scale (0.2 to 8)
            return (sliderValue / 100) * (maxScale - minScale) + minScale;
        }
        
        // --- Core Functions ---
        
        /**
         * Converts the displayed image to a Base64 string for the Gemini API.
         * Requires image to have loaded with crossOrigin="anonymous".
         * @returns {string | null} Base64 string or null on failure.
         */
        function getImageBase64() {
            if (!viewerImage.complete || viewerImage.naturalWidth === 0) {
                console.error("Viewer image is not yet loaded.");
                return null;
            }
            
            try {
                const canvas = document.createElement('canvas');
                canvas.width = viewerImage.naturalWidth;
                canvas.height = viewerImage.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(viewerImage, 0, 0);
                
                // Get the base64 data, removing the header part "data:image/png;base64,"
                const base64Url = canvas.toDataURL('image/png');
                return base64Url.split(',')[1];
            } catch (e) {
                console.error("Error generating Base64 from image. Check CORS settings on the image source.", e);
                return null;
            }
        }
        
        /**
         * Calls the Gemini API for image analysis.
         */
        async function analyzeImageWithGemini() {
            const userQuery = aiPromptInput.value.trim();
            
            // Define a default summary prompt if the user query is empty
            const defaultPrompt = "Provide a concise, detailed summary of the main astronomical features, structures, and star types visible in this image. Focus on potential research points and overall image composition.";
            
            const effectiveQuery = userQuery || defaultPrompt;


            const base64ImageData = getImageBase64();
            if (!base64ImageData) {
                aiResponseArea.innerHTML = `<p class="text-red-400 italic">Could not capture image data for AI analysis. Ensure the image is fully loaded and public.</p>`;
                return;
            }

            // Show loading state
            aiAnalyzeBtn.disabled = true;
            aiAnalyzeBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Analyzing...`;
            aiResponseArea.innerHTML = `<p class="text-gray-400 italic">Sending image data to Gemini...</p>`;
            
            const systemPrompt = `You are a highly detailed NASA Research Assistant specializing in deep space and planetary image analysis. Your task is to analyze the provided image based on the user's query. Respond clearly and concisely, formatting your response using Markdown for readability.`;
            
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: effectiveQuery },
                            {
                                inlineData: {
                                    mimeType: "image/png",
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                let response;
                const maxRetries = 3;
                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else if (response.ok) {
                        break;
                    } else {
                        throw new Error(`API returned status code: ${response.status}`);
                    }
                }
                
                if (!response.ok) {
                    throw new Error("Failed to get response after retries.");
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "No analysis generated. The model may have blocked the content or encountered an internal error.";
                
                // Display the analysis result (using a simple pre-tag for markdown rendering)
                aiResponseArea.innerHTML = `<pre class="whitespace-pre-wrap font-sans text-xs">${text}</pre>`;

            } catch (error) {
                console.error("Gemini API Error:", error);
                aiResponseArea.innerHTML = `<p class="text-red-400">Error: Failed to connect to the analysis model. Check console for details. (Type: ${error.message})</p>`;
            } finally {
                aiAnalyzeBtn.disabled = false;
                aiAnalyzeBtn.innerHTML = 'Generate Summary / Analyze';
            }
        }
        
        /**
         * Initializes and loads a new image URL, resetting the viewer state.
         * @param {string} url - The URL of the image to load.
         */
        function initializeImage(url) {
            // 1. Reset the current image object event handlers and source
            currentImage.onload = null;
            currentImage.onerror = null;

            // Prepare UI for loading
            viewerImage.classList.add('invisible');
            loadingSpinner.style.display = 'flex';
            viewerImage.src = ''; // Clear source while loading
            loadingSpinner.innerHTML = `<svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            // 2. Set crossOrigin to resolve CORS issues when accessing naturalWidth/naturalHeight from external domains
            currentImage.crossOrigin = 'anonymous'; 

            // 3. Setup handlers for the new image
            currentImage.onload = () => {
                loadingSpinner.style.display = 'none';
                viewerImage.src = url; // Set the actual element src once loaded
                viewerImage.crossOrigin = 'anonymous'; // Set on the displayed image as well
                viewerImage.classList.remove('invisible');
                // Clear AI response when image changes
                aiResponseArea.innerHTML = `<p class="text-gray-400 italic">AI analysis results will appear here.</p>`; 

                if (!modal.classList.contains('hidden')) {
                    resetAndFitImage();
                }
            };
            currentImage.onerror = () => {
                // Display informative error message with an option to close it
                loadingSpinner.innerHTML = `
                    <div class="text-center text-red-400 p-6 rounded-lg bg-gray-700 max-w-xs mx-auto shadow-xl">
                        <p class="text-lg font-bold">⚠️ Image Load Failed ⚠️</p>
                        <p class="mt-2 text-sm text-gray-300">Please check that the URL links **directly** to a public image file (e.g., ends in .jpg, .png).</p>
                        <button id="clear-error-btn" class="mt-4 bg-red-600 hover:bg-red-700 text-white text-sm py-1 px-3 rounded-md transition-colors">Acknowledge</button>
                    </div>
                `;
                // Add listener to clear the error message
                document.getElementById('clear-error-btn').addEventListener('click', () => {
                    loadingSpinner.style.display = 'none';
                });
                viewerImage.classList.add('invisible');
            };

            // 4. Start loading
            currentImage.src = url;
        }

        function loadNewImage() {
            const newUrl = imageUrlInput.value.trim();
            if (newUrl) {
                initializeImage(newUrl);
                imageUrlInput.value = ''; // Clear input after successful attempt
            } else {
                // Simple visual feedback for empty input
                imageUrlInput.placeholder = "Please paste a URL!";
                setTimeout(() => {
                     imageUrlInput.placeholder = "Paste NASA Image URL here";
                }, 1500);
            }
        }

        function updateTransform() {
            viewerImage.style.transform = `translate(${state.translateX}px, ${state.translateY}px) rotate(${state.rotate}deg) scaleX(${state.flipX}) scale(${state.scale})`;
            
            // Update zoom level display and slider position
            zoomLevelDisplay.textContent = `${Math.round(state.scale * 100)}%`;
            zoomSlider.value = scaleToSlider(state.scale);

            // Set cursor based on zoom/mode
            if (state.scale > 1) {
                imageContainer.style.cursor = 'grab';
            } else {
                imageContainer.style.cursor = 'default';
            }
        }

        function resetAndFitImage() {
            state = { scale: 1, translateX: 0, translateY: 0, rotate: 0, flipX: 1 };
            const containerRect = imageContainer.getBoundingClientRect();
            
            const imgAspectRatio = currentImage.naturalWidth / currentImage.naturalHeight;
            const containerAspectRatio = containerRect.width / containerRect.height;
            
            let imgWidth, imgHeight;

            if (imgAspectRatio > containerAspectRatio) {
                imgWidth = containerRect.width * 0.9;
                imgHeight = imgWidth / imgAspectRatio;
            } else {
                imgHeight = containerRect.height * 0.9;
                imgWidth = imgHeight * imgAspectRatio;
            }
            
            viewerImage.style.width = `${imgWidth}px`;
            viewerImage.style.height = `${imgHeight}px`;

            state.translateX = (containerRect.width - imgWidth) / 2;
            state.translateY = (containerRect.height - imgHeight) / 2;
            
            updateTransform();
        }

        function openTheModal() {
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            if (currentImage.complete && currentImage.src) {
                resetAndFitImage();
            } else {
                loadingSpinner.style.display = 'flex';
                viewerImage.classList.add('invisible');
            }
        }

        function closeTheModal() {
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            // This logic is now handled by the fullscreenBtn listener, but keeping a fallback
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }
        
        function applyZoom(newScale, centerX, centerY) {
            const oldScale = state.scale;
            state.scale = Math.max(minScale, Math.min(maxScale, newScale));

            // Adjust translation based on the zoom center (applies to mouse wheel and touch)
            state.translateX = centerX - (centerX - state.translateX) * (state.scale / oldScale);
            state.translateY = centerY - (centerY - state.translateY) * (state.scale / oldScale);
            
            updateTransform();
        }
        
        // --- Event Listeners ---
        window.onload = () => {
            initializeImage(viewerImage.src);
        };

        openModalBtn.addEventListener('click', openTheModal);
        closeModal.addEventListener('click', closeTheModal);
        aiAnalyzeBtn.addEventListener('click', analyzeImageWithGemini); // New listener for AI analysis

        // New Image Loading Listeners
        loadImageBtn.addEventListener('click', loadNewImage);
        imageUrlInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                loadNewImage();
            }
        });
        
        // SLIDER CONTROL
        zoomSlider.addEventListener('input', () => {
            // Calculate new scale based on slider position
            const newScale = sliderToScale(parseInt(zoomSlider.value));
            
            // Use the center of the viewport as the zoom reference point
            const rect = imageContainer.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            applyZoom(newScale, centerX, centerY);
        });

        // Controls
        resetViewBtn.addEventListener('click', resetAndFitImage);
        rotateLeftBtn.addEventListener('click', () => { state.rotate -= 90; updateTransform(); });
        rotateRightBtn.addEventListener('click', () => { state.rotate += 90; updateTransform(); });
        flipHorizontalBtn.addEventListener('click', () => { state.flipX *= -1; updateTransform(); });
        
        // --- Fullscreen Fix ---
        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                // Enter Fullscreen (using cross-browser approach)
                const element = modal;
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.mozRequestFullScreen) { // Firefox
                    element.mozRequestFullScreen();
                } else if (element.webkitRequestFullscreen) { // Chrome, Safari, Opera
                    element.webkitRequestFullscreen();
                } else if (element.msRequestFullscreen) { // IE/Edge
                    element.msRequestFullscreen();
                }
            } else {
                // Exit Fullscreen (using cross-browser approach)
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { // Firefox
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { // Chrome, Safari, Opera
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE/Edge
                    document.msExitFullscreen();
                }
            }
        });
        // --- End Fullscreen Fix ---


        // Mouse Pan
        imageContainer.addEventListener('mousedown', (e) => {
            if (e.button !== 0 || state.scale <= 1) return;
            e.preventDefault();
            panning = true;
            start = { x: e.clientX - state.translateX, y: e.clientY - state.translateY };
            imageContainer.classList.add('grabbing');
        });
        window.addEventListener('mouseup', () => {
            panning = false;
            imageContainer.classList.remove('grabbing');
        });
        window.addEventListener('mousemove', (e) => {
            if (!panning) return;
            e.preventDefault();
            state.translateX = e.clientX - start.x;
            state.translateY = e.clientY - start.y;
            updateTransform();
        });

        // Mouse Wheel Zoom
        imageContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            const rect = imageContainer.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // Map wheel delta to scale change (smoother and relative to current scale)
            const scaleChange = -e.deltaY * 0.001 * state.scale;
            const newScale = state.scale + scaleChange;

            applyZoom(newScale, mouseX, mouseY);
        }, { passive: false });

        // Touch Gestures
        imageContainer.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                panning = false;
                lastTouchDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            } else if (e.touches.length === 1 && state.scale > 1) {
                panning = true;
                start = { x: e.touches[0].clientX - state.translateX, y: e.touches[0].clientY - state.translateY };
            }
        }, { passive: true });

        imageContainer.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2 && lastTouchDistance) { // Pinch zoom
                e.preventDefault();
                const newTouchDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                const rect = imageContainer.getBoundingClientRect();
                const touchCenterX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
                const touchCenterY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;
                const scaleFactor = newTouchDistance / lastTouchDistance;
                applyZoom(state.scale * scaleFactor, touchCenterX, touchCenterY);
                lastTouchDistance = newTouchDistance;
            } else if (e.touches.length === 1 && panning) { // Pan
                e.preventDefault();
                state.translateX = e.touches[0].clientX - start.x;
                state.translateY = e.touches[0].clientY - start.y;
                updateTransform();
            }
        }, { passive: false });

        imageContainer.addEventListener('touchend', () => {
            panning = false;
            lastTouchDistance = null;
        });

        window.addEventListener('resize', () => {
            if (!modal.classList.contains('hidden')) resetAndFitImage();
        });

    </script>
</body>
</html>
